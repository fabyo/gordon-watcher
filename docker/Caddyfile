:8080 {
    # Serve static files (Dashboard)
    root * /srv
    
    # Proxy Grafana (must come before file_server)
    handle /grafana* {
        reverse_proxy grafana:3000
    }

    # Proxy Prometheus (must come before file_server)
    handle_path /prometheus/* {
        reverse_proxy prometheus:9090
    }

    # Proxy metrics requests to the backend
    handle_path /api/metrics {
        reverse_proxy watcher:9100 {
            header_up Host {upstream_hostport}
            rewrite /metrics
        }
    }

    # Health check for Caddy itself
    handle /health {
        respond "OK" 200
    }

    # Serve static files (must be last)
    file_server
}
